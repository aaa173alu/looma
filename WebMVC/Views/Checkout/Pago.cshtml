@{
    ViewData["Title"] = "Finalizar Compra - Pago";
    var total = ViewBag.Total as decimal?;
    var nombre = ViewBag.Nombre as string;
    var direccion = ViewBag.Direccion as string;
    var tarjeta = ViewBag.TarjetaPredeterminada as ApplicationCore.Domain.EN.Tarjeta;
}

<div class="container mt-4">
    <div class="row">
        <!-- Formulario de pago -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">üí≥ Paso 2: M√©todo de Pago</h4>
                </div>
                <div class="card-body">
                    <form id="form-pago">
                        <!-- Opciones de pago -->
                        <div class="mb-4">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="tipoPago" id="tarjeta-guardada" value="guardada" @(tarjeta != null ? "checked" : "disabled") onclick="seleccionarTipoPago('guardada')">
                                <label class="form-check-label fw-bold" for="tarjeta-guardada">
                                    üí≥ Usar tarjeta guardada
                                </label>
                                <div class="ms-4 mt-2" id="info-tarjeta-guardada" style="@(tarjeta == null ? "display:none;" : "")">
                                    @if (tarjeta != null)
                                    {
                                        <div class="card bg-dark text-white" style="max-width: 350px;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="badge bg-warning text-dark">@tarjeta.Marca</span>
                                                    <small>Exp: @tarjeta.MesExp/@tarjeta.AnioExp</small>
                                                </div>
                                                <div style="font-family: monospace; font-size: 1.1rem; letter-spacing: 2px;">
                                                    @tarjeta.NumeroEnmascarado
                                                </div>
                                                <div class="mt-2">
                                                    <small>@tarjeta.NombreTitular</small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning mb-0">No tienes tarjeta guardada. A√±ade una nueva.</div>
                                    }
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoPago" id="otra-tarjeta" value="nueva" @(tarjeta == null ? "checked" : "") onclick="seleccionarTipoPago('nueva')">
                                <label class="form-check-label fw-bold" for="otra-tarjeta">
                                    ‚ûï Usar otra tarjeta
                                </label>
                            </div>
                        </div>

                        <hr>

                        <!-- Campos de tarjeta -->
                        <div id="form-nueva-tarjeta" style="display: none;">
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label for="numero-tarjeta" class="form-label">N√∫mero de tarjeta *</label>
                                    <input type="text" class="form-control" id="numero-tarjeta" name="numeroTarjeta" placeholder="1234 5678 9012 3456" maxlength="19">
                                    <small class="text-muted">Tarjetas de prueba v√°lidas:</small>
                                    <ul class="small text-muted mt-1">
                                        <li>Visa: <code>4532 1488 0343 6467</code></li>
                                        <li>Mastercard: <code>5425 2334 3010 9903</code></li>
                                    </ul>
                                </div>
                                <div class="col-12">
                                    <label for="titular-tarjeta" class="form-label">Nombre del titular *</label>
                                    <input type="text" class="form-control" id="titular-tarjeta" name="titularTarjeta" placeholder="Nombre como aparece en la tarjeta" value="@nombre">
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha-expiracion" class="form-label">Fecha de expiraci√≥n *</label>
                                    <input type="text" class="form-control" id="fecha-expiracion" name="fechaExpiracion" placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="col-md-6">
                                    <label for="cvv" class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="3">
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <strong>üîí Pago seguro simulado</strong>
                            <p class="mb-0 small">Este es un entorno de prueba. No se procesar√°n cargos reales.</p>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg" id="btn-pagar">
                                üîí Pagar @total?.ToString("C")
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                ‚Üê Volver a Datos de Env√≠o
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Datos de env√≠o -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">üì¶ Datos de Env√≠o</h6>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>Nombre:</strong> @nombre</p>
                    <p class="mb-0"><strong>Direcci√≥n:</strong> @direccion</p>
                </div>
            </div>
        </div>

        <!-- Resumen del pedido -->
        <div class="col-md-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üí∞ Total a Pagar</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0 text-success">@total?.ToString("C")</h3>
                    </div>
                    <hr>
                    <ul class="list-unstyled small">
                        <li>‚úì Env√≠o gratuito</li>
                        <li>‚úì Devoluci√≥n en 30 d√≠as</li>
                        <li>‚úì Pago 100% seguro</li>
                        <li>‚úì Garant√≠a de satisfacci√≥n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const hayTarjetaGuardada = @(tarjeta != null ? "true" : "false");
        let usarTarjetaGuardada = hayTarjetaGuardada;

        function seleccionarTipoPago(tipo) {
            const formNuevaTarjeta = document.getElementById('form-nueva-tarjeta');
            const infoTarjetaGuardada = document.getElementById('info-tarjeta-guardada');
            
            if (tipo === 'guardada') {
                if (!hayTarjetaGuardada) {
                    mostrarMensaje('No tienes tarjeta guardada. Usa otra tarjeta.', 'warning');
                    document.getElementById('otra-tarjeta').checked = true;
                    formNuevaTarjeta.style.display = 'block';
                    infoTarjetaGuardada.style.display = 'none';
                    usarTarjetaGuardada = false;
                    return;
                }
                formNuevaTarjeta.style.display = 'none';
                infoTarjetaGuardada.style.display = 'block';
                usarTarjetaGuardada = true;
            } else {
                formNuevaTarjeta.style.display = 'block';
                infoTarjetaGuardada.style.display = 'none';
                usarTarjetaGuardada = false;
            }
        }

        // Formatear n√∫mero de tarjeta
        document.getElementById('numero-tarjeta')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Formatear fecha de expiraci√≥n
        document.getElementById('fecha-expiracion')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Solo n√∫meros en CVV
        document.getElementById('cvv')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Estado inicial
        seleccionarTipoPago(hayTarjetaGuardada ? 'guardada' : 'nueva');

        document.getElementById('form-pago').addEventListener('submit', function(e) {
            e.preventDefault();

            let numeroTarjeta, fechaExpiracion, cvv, titularTarjeta;

            if (usarTarjetaGuardada) {
                // Usar tarjeta guardada
                numeroTarjeta = '4532148803436467';
                fechaExpiracion = '12/26';
                cvv = '123';
                titularTarjeta = '@(tarjeta != null ? tarjeta.NombreTitular : nombre)';
            } else {
                // Validar nueva tarjeta
                numeroTarjeta = document.getElementById('numero-tarjeta').value.replace(/\s/g, '');
                fechaExpiracion = document.getElementById('fecha-expiracion').value;
                cvv = document.getElementById('cvv').value;
                titularTarjeta = document.getElementById('titular-tarjeta').value;

                if (!numeroTarjeta || numeroTarjeta.length < 15) {
                    mostrarMensaje('‚ö†Ô∏è N√∫mero de tarjeta inv√°lido', 'warning');
                    return;
                }

                if (!fechaExpiracion || !fechaExpiracion.match(/^\d{2}\/\d{2}$/)) {
                    mostrarMensaje('‚ö†Ô∏è Fecha de expiraci√≥n inv√°lida (MM/YY)', 'warning');
                    return;
                }

                if (!cvv || cvv.length < 3) {
                    mostrarMensaje('‚ö†Ô∏è CVV inv√°lido', 'warning');
                    return;
                }

                if (!titularTarjeta || titularTarjeta.trim() === '') {
                    mostrarMensaje('‚ö†Ô∏è Nombre del titular requerido', 'warning');
                    return;
                }
            }

            const btn = document.getElementById('btn-pagar');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Procesando pago...';

            // Procesar pago
            fetch('/Checkout/ProcesarPago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tipoPago: usarTarjetaGuardada ? 'guardada' : 'nueva',
                    numeroTarjeta: numeroTarjeta,
                    fechaExpiracion: fechaExpiracion,
                    cvv: cvv,
                    titularTarjeta: titularTarjeta
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje('‚úÖ ' + data.message, 'success');
                    setTimeout(() => {
                        window.location.href = '/Checkout/Confirmacion?pedidoId=' + data.pedidoId;
                    }, 1500);
                } else {
                    mostrarMensaje('‚ùå ' + data.message, 'danger');
                    btn.disabled = false;
                    btn.innerHTML = 'üîí Pagar @total?.ToString("C")';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('‚ùå Error al procesar el pago', 'danger');
                btn.disabled = false;
                btn.innerHTML = 'üîí Pagar @total?.ToString("C")';
            });
        });

        function mostrarMensaje(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            alertDiv.innerHTML = `
                <strong>${mensaje}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 3000);
        }
    </script>
}
